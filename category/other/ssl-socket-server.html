<!DOCTYPE html>
<html lang="en" id="page"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"><meta charset="utf-8"/><meta name="viewport" content="width=device-width"/><title>Prototype SSL Socket Server - Other  - Haxe programming language cookbook</title><base href="./../.."/>
<link rel="stylesheet" type="text/css" href="https://haxe.org/css/bootstrap.min.css"/><link rel="stylesheet" type="text/css" href="css/styles.min.css"/><link rel="stylesheet" type="text/css" href="css/haxe-nav.min.css"/><link rel="stylesheet" type="text/css" href="css/fonts.min.css"/><link rel="icon" href="https://haxe.org/favicon.ico"/><link rel="canonical" href="https://code.haxe.org/category/other/ssl-socket-server.html"/><link href="https://code.haxe.org/rss.xml" rel="alternate" type="application/atom+xml" title="RSS Feed Haxe Code Cookbook"/><meta name="description" content="This write-up was inspired by this stack overflow question. While I&#039;ve worked with sockets before, I wanted to prototype a Haxe HXCPP socket server leveraging secure SSL connections."/>
<meta name="twitter:creator" content="@haxe_org"/>
<meta property="og:title" content="Prototype SSL Socket Server - Other  - Haxe programming language cookbook"/><meta property="og:description" content="This write-up was inspired by this stack overflow question. While I&#039;ve worked with sockets before, I wanted to prototype a Haxe HXCPP socket server leveraging secure SSL connections."/><meta property="og:type" content="article"/><meta property="og:url" content="https://code.haxe.org/category/other/ssl-socket-server.html"/><meta property="og:image" content="https://code.haxe.org/img/share.png"/><meta property="article:publisher" content="haxe.org"/><meta property="article:published_time" content="2019-06-20 01:01:01"/><meta property="article:modified_time" content="2019-07-04 01:01:01"/><meta property="article:section" content="technology"/><meta property="article:tag" content="server,multi-threading,hxcpp"/></head><body><script type="text/javascript">function startsWith(str, searchString){return str.substr(0, searchString.length) === searchString;}if (!startsWith(location.href, "https://code.haxe.org/")) {window.location.replace("https://code.haxe.org/category/other/ssl-socket-server.html");}</script><nav class="section nav dark"><div class="navbar navbar-fixed-top navbar-inverse"><div class="navbar-inner"><button class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse" type="button"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="brand haxe-logo" href="https://haxe.org/"><img alt="Haxe" height="21" onerror="this.src=&#039;https://haxe.org/img/haxe-logo-horizontal-on-dark.png&#039;" src="https://haxe.org/img/haxe-logo-horizontal-on-dark.svg" width="107"/></a><a class="brand sub ide" href="./">CODE</a><div class="nav-collapse collapse"><ul class="nav">
<li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-book"></i> Browse <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="category/beginner/">Beginner <small class="category-count">(19)</small></a></li><li><a href="category/abstract-types/">Abstract types <small class="category-count">(7)</small></a></li><li><a href="category/compilation/">Compilation <small class="category-count">(1)</small></a></li><li><a href="category/data-structures/">Data structures <small class="category-count">(5)</small></a></li><li><a href="category/design-patterns/">Design patterns <small class="category-count">(4)</small></a></li><li><a href="category/functional-programming/">Functional Programming <small class="category-count">(2)</small></a></li><li><a href="category/javascript/">JavaScript <small class="category-count">(4)</small></a></li><li><a href="category/macros/">Macros <small class="category-count">(18)</small></a></li><li><a href="category/principles/">Principles <small class="category-count">(3)</small></a></li><li class="active"><a href="category/other/">Other <small class="category-count">(8)</small></a></li></ul></li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-tags"></i> Tags <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="tag/expression-macro.html" rel="tag"><i class="fa fa-tag"></i> expression macro <small class="category-count">(10)</small></a></li><li><a href="tag/abstract-type.html" rel="tag"><i class="fa fa-tag"></i> abstract type <small class="category-count">(8)</small></a></li><li><a href="tag/building-fields.html" rel="tag"><i class="fa fa-tag"></i> building fields <small class="category-count">(8)</small></a></li><li><a href="tag/enum.html" rel="tag"><i class="fa fa-tag"></i> enum <small class="category-count">(7)</small></a></li><li><a href="tag/build-macro.html" rel="tag"><i class="fa fa-tag"></i> build macro <small class="category-count">(7)</small></a></li><li><a href="tag/javascript.html" rel="tag"><i class="fa fa-tag"></i> javascript <small class="category-count">(6)</small></a></li><li><a href="tag/data-structures.html" rel="tag"><i class="fa fa-tag"></i> data structures <small class="category-count">(5)</small></a></li><li><a href="tag/dead-code-elimination.html" rel="tag"><i class="fa fa-tag"></i> dead code elimination <small class="category-count">(4)</small></a></li><li><a href="tag/pattern-matching.html" rel="tag"><i class="fa fa-tag"></i> pattern matching <small class="category-count">(4)</small></a></li><li><a href="tag/iterator.html" rel="tag"><i class="fa fa-tag"></i> iterator <small class="category-count">(4)</small></a></li><li><a href="tag/collections.html" rel="tag"><i class="fa fa-tag"></i> collections <small class="category-count">(4)</small></a></li><li><a href="tag/validation.html" rel="tag"><i class="fa fa-tag"></i> validation <small class="category-count">(3)</small></a></li><li><a href="tag/class.html" rel="tag"><i class="fa fa-tag"></i> class <small class="category-count">(3)</small></a></li><li><a href="tag/array.html" rel="tag"><i class="fa fa-tag"></i> array <small class="category-count">(3)</small></a></li><li><a href="tag/libraries.html" rel="tag"><i class="fa fa-tag"></i> libraries <small class="category-count">(3)</small></a></li><li><a href="tag/multi-threading.html" rel="tag"><i class="fa fa-tag"></i> multi threading <small class="category-count">(2)</small></a></li><li><a href="tag/math.html" rel="tag"><i class="fa fa-tag"></i> math <small class="category-count">(2)</small></a></li><li><a href="tag/type-params.html" rel="tag"><i class="fa fa-tag"></i> type params <small class="category-count">(2)</small></a></li><li><a href="tag/static-extension.html" rel="tag"><i class="fa fa-tag"></i> static extension <small class="category-count">(2)</small></a></li><li><a href="tag/server.html" rel="tag"><i class="fa fa-tag"></i> server <small class="category-count">(2)</small></a></li><li><a href="tag/git.html" rel="tag"><i class="fa fa-tag"></i> git <small class="category-count">(2)</small></a></li><li><a href="tag/ereg.html" rel="tag"><i class="fa fa-tag"></i> ereg <small class="category-count">(2)</small></a></li><li><a href="tag/reflection.html" rel="tag"><i class="fa fa-tag"></i> reflection <small class="category-count">(2)</small></a></li><li><a href="tag/arguments.html" rel="tag"><i class="fa fa-tag"></i> arguments <small class="category-count">(2)</small></a></li><li><a href="tag/filesystem.html" rel="tag"><i class="fa fa-tag"></i> filesystem <small class="category-count">(2)</small></a></li><li><a href="tag/conditional-compilation.html" rel="tag"><i class="fa fa-tag"></i> conditional compilation <small class="category-count">(2)</small></a></li></ul></li><li class="divider"></li>
<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="https://haxe.org/documentation/">Learn Haxe <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="https://haxe.org/documentation/introduction/" rel="external">Introduction</a></li><li><a href="https://haxe.org/manual/" rel="external">Manual</a></li><li class="active"><a href="https://code.haxe.org" rel="external">Code Cookbook</a></li><li><a href="https://api.haxe.org" rel="external">API Documentation</a></li><li class="divider"></li><li><a href="https://haxe.org/videos/" rel="external">Videos</a></li><li class="divider"></li><li><a href="https://try.haxe.org" rel="external">Try Haxe online</a></li><li><a href="https://lib.haxe.org" rel="external">Haxelib</a></li></ul></li><li class=" dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Connect <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="https://github.com/HaxeFoundation" rel="external"><i class="fa fa-github"></i> GitHub</a></li><li><a href="https://github.com/HaxeFoundation/haxe/issues" rel="external"><i class="fa fa-github"></i> Bug reports</a></li><li><a href="https://stackoverflow.com/questions/tagged/haxe" rel="external"><i class="fa fa-stack-overflow"></i> Stack Overflow</a></li><li><a href="http://community.haxe.org/" rel="external"><i class="fa fa-envelope-o"></i> Forums</a></li><li><a href="https://discordapp.com/invite/0uEuWH3spjck73Lo" rel="external nofollow"><i class="fa fa-comments-o"></i> Discord</a></li><li><a href="https://gitter.im/HaxeFoundation/haxe" rel="external nofollow"><i class="fa fa-comments-o"></i> Gitter</a></li><li><a href="https://haxe.org/blog"><i class="fa fa-rss"></i> Blog</a></li><li class="divider"></li><li><a href="https://www.facebook.com/haxe.org/" rel="external"><i class="fa fa-facebook"></i> Facebook</a></li><li><a href="https://twitter.com/search?q=%23haxe" rel="external"><i class="fa fa-twitter"></i> #haxe</a></li><li><a href="https://twitter.com/haxelang" rel="external"><i class="fa fa-twitter"></i> @haxelang</a></li><li><a href="https://twitter.com/haxe_org" rel="external"><i class="fa fa-twitter"></i> @haxe_org</a></li><li class="divider"></li><li><a href="https://haxe.org/foundation/contact.html" rel="external">Contact</a></li></ul></li></ul></div></div></div></nav><div class="main-content"><header class="hero-unit-small"><div class="container"><div class="row"><div id="title">Haxe Code Cookbook</div></div></div></header><main class="container"><section class="row"><nav class="span4 sidebar-toc" id="sidebar"><h3>Table of contents</h3><ul class="unstyled"><li><a href="category/beginner/">Beginner</a><ul class="unstyled"><li><a href="category/beginner/arrays.html">Using arrays</a></li><li><a href="category/beginner/conditional-compilation.html">Conditional compilation</a></li><li><a href="category/beginner/date-time.html">Working with date and time</a></li><li><a href="category/beginner/declare-classes.html">Declare classes</a></li><li><a href="category/beginner/declare-functions.html">Declare functions</a></li><li><a href="category/beginner/enum-adt.html">Using enum / ADT</a></li><li><a href="category/beginner/haxe-to-emscripten-hello-world.html">Haxe to Emscripten</a></li><li><a href="category/beginner/hello-world.html">Hello world</a></li><li><a href="category/beginner/lists.html">Using lists</a></li><li><a href="category/beginner/loading-external-files.html">Loading a file from web</a></li><li><a href="category/beginner/maps.html">Using maps</a></li><li><a href="category/beginner/numbers-floats-ints.html">Using numbers</a></li><li><a href="category/beginner/pattern-matching.html">Pattern matching</a></li><li><a href="category/beginner/reflection-method-call.html">Invoke object method by string</a></li><li><a href="category/beginner/regular-expressions.html">Using regular expressions</a></li><li><a href="category/beginner/string-variable-reflection.html">Access a field by string</a></li><li><a href="category/beginner/strings.html">Using strings</a></li><li><a href="category/beginner/using-filesystem.html">Using the file system</a></li><li><a href="category/beginner/using-static-extensions.html">Using static extensions</a></li></ul></li><br/><li><a href="category/abstract-types/">Abstract types</a><ul class="unstyled"><li><a href="category/abstract-types/abstracts-with-type-params.html">Strict typing for stringly-typed extern code</a></li><li><a href="category/abstract-types/array-access-db-manager.html">Array access of a database manager</a></li><li><a href="category/abstract-types/color.html">Color as abstract type</a></li><li><a href="category/abstract-types/emailaddress.html">Email address as abstract type</a></li><li><a href="category/abstract-types/rounded-float.html">Rounded Float as abstract type</a></li><li><a href="category/abstract-types/temperature-units.html">Temperature units as abstract type</a></li><li><a href="category/abstract-types/using-iterators-as-generic-type-parameters.html">Using Iterators as Generic Type Parameters</a></li></ul></li><br/><li><a href="category/compilation/">Compilation</a><ul class="unstyled"><li><a href="category/compilation/compiling-libraries-without-main-class.html">Compiling libraries without main class</a></li></ul></li><br/><li><a href="category/data-structures/">Data structures</a><ul class="unstyled"><li><a href="category/data-structures/grid-iterator.html">Grid iterator</a></li><li><a href="category/data-structures/reverse-iterator.html">Reverse iterator</a></li><li><a href="category/data-structures/ring-array.html">A fixed ring array</a></li><li><a href="category/data-structures/sort-array.html">Sorting arrays</a></li><li><a href="category/data-structures/step-iterator.html">Stepped iterator</a></li></ul></li><br/><li><a href="category/design-patterns/">Design patterns</a><ul class="unstyled"><li><a href="category/design-patterns/factory.html">Factory</a></li><li><a href="category/design-patterns/lazy-initialization.html">Lazy initialization</a></li><li><a href="category/design-patterns/observer.html">Observer</a></li><li><a href="category/design-patterns/singleton.html">Singleton</a></li></ul></li><br/><li><a href="category/functional-programming/">Functional Programming</a><ul class="unstyled"><li><a href="category/functional-programming/enum-gadt.html">Enums as GADTs</a></li><li><a href="category/functional-programming/functional-style-expression-evaluation.html">ML-Style Parse Tree Evaluation</a></li></ul></li><br/><li><a href="category/javascript/">JavaScript</a><ul class="unstyled"><li><a href="category/javascript/adding-element-to-dom.html">Adding a HTML element to the DOM</a></li><li><a href="category/javascript/creating-node-server.html">Create a server with Haxe/NodeJS</a></li><li><a href="category/javascript/javascript-inline-workers.html">JavaScript inline web workers in Haxe</a></li><li><a href="category/javascript/using-haxe-classes-in-javascript.html">Using Haxe classes in JavaScript</a></li></ul></li><br/><li><a href="category/macros/">Macros</a><ul class="unstyled"><li><a href="category/macros/add-git-commit-hash-in-build.html">Add git commit-hash in build</a></li><li><a href="category/macros/add-parameters-as-fields.html">Add parameters as fields</a></li><li><a href="category/macros/assert-with-values.html">Assert macro that shows sub-expression values</a></li><li><a href="category/macros/build-arrays.html">Generating Arrays with values</a></li><li><a href="category/macros/build-map.html">Add a map</a></li><li><a href="category/macros/build-property-with-inline-getter.html">Add property with getter</a></li><li><a href="category/macros/build-static-field.html">Add a static field</a></li><li><a href="category/macros/build-value-objects.html">Create value-objects</a></li><li><a href="category/macros/combine-objects.html">Combine two or more structures</a></li><li><a href="category/macros/completion-from-url.html">Code completion from URL</a></li><li><a href="category/macros/enum-abstract-values.html">Get all values of an @:enum abstract</a></li><li><a href="category/macros/extract-enum-value.html">Extract values from known enum instances</a></li><li><a href="category/macros/generate-dispatch-code.html">Generate dispatch code</a></li><li><a href="category/macros/generating-code-in-a-macro.html">Generating code in a macro</a></li><li><a href="category/macros/get-compiler-define-value.html">Working with compiler flags</a></li><li><a href="category/macros/include-file-next-to-module-file.html">Include a file next to a Haxe module file</a></li><li><a href="category/macros/threading-macro.html">Threading macro like Clojure and pipe operator</a></li><li><a href="category/macros/validate-json.html">Validates a .JSON file compile-time</a></li></ul></li><br/><li><a href="category/principles/">Principles</a><ul class="unstyled"><li><a href="category/principles/everything-is-an-expression.html">Everything is an expression</a></li><li><a href="category/principles/inheritance.html">Inheritance</a></li><li><a href="category/principles/null-safety.html">Null safety</a></li></ul></li><br/><li><a href="category/other/" class="active">Other</a><ul class="unstyled"><li><a href="category/other/adding-static-methods-to-existing-classes.html">Adding static methods to existing classes</a></li><li><a href="category/other/base64-encoding.html">Base64 encoding</a></li><li><a href="category/other/deploy-to-haxelib-using-travis-and-github-releases.html">Publish to Haxelib using Travis and Github Releases</a></li><li><a href="category/other/haxe-zip.html">Zip files</a></li><li><a href="category/other/named-parameters.html">Named Parameters</a></li><li><a href="category/other/passing-different-types-to-a-function-parameter.html">Passing different types to a function parameter</a></li><li class="active"><a href="category/other/ssl-socket-server.html">Prototype SSL Socket Server</a></li><li><a href="category/other/vga-text-renderer.html">VGA text renderer</a></li><li><a href="category/other/working-with-cppia/index.html">Working with cppia</a></li></ul></li><br/></ul></nav><article class="span8" itemscope="itemscope" itemtype="http://schema.org/Article"><big class="pull-right"><a href="https://github.com/HaxeFoundation/code-cookbook/edit/master/./assets/content/cookbook/Other/ssl-socket-server.md?message=Update:%20Prototype SSL Socket Server&amp;description=%0A%0ASources:%0A*%20https://code.haxe.org/category/other/ssl-socket-server.html%0A%0A%40jcward " title="Edit &#039;Prototype SSL Socket Server&#039; on GitHub" rel="external"><i class="fa fa fa-edit"></i></a></big> <small itemscope="itemscope" itemtype="http://schema.org/BreadcrumbList"><span itemprop="itemListElement" itemscope="itemscope" itemtype="http://schema.org/ListItem"><a itemprop="name" href="/">Haxe programming cookbook</a> › </span><span itemprop="itemListElement" itemscope="itemscope" itemtype="http://schema.org/ListItem"><a itemprop="name" href="category/other/">Other</a> › </span><span itemprop="itemListElement" itemscope="itemscope" itemtype="http://schema.org/ListItem"><a itemprop="name" href="category/other/ssl-socket-server.html">Prototype SSL Socket Server</a></span></small><h1><a href="https://code.haxe.org/category/other/ssl-socket-server.html" itemprop="url" class="anchorjs-icons"></a> <span itemprop="name">Prototype SSL Socket Server</span></h1><p class="reading-time">Reading time: 4 minutes</p><div itemprop="articleBody"><p>This write-up was inspired by <a href="https://stackoverflow.com/questions/56418671/how-to-use-haxe-ssl-socket/56692779#56692779">this stack overflow question</a>.
While I've worked with sockets before, I wanted to prototype a Haxe HXCPP socket server leveraging secure SSL connections.</p>
<h3>OS Note</h3>
<p>I use Linux, so this write-up is written from that perspective. Commands shown will likely
be similar on OSX. Windows users will have to modify some commands. I used Haxe 4.0.0-rc1 and hxcpp
4.0.19 for this test.</p>
<h3>Getting Started</h3>
<p>The first thing you'll need for playing with SSL is a certificate and a key file.</p>
<h4>Test Certificates</h4>
<p>The OpenSSL project has some test certificates that you can use. You can download the certificate and key files
directly from their github repo:</p><ul><li><a href="https://raw.githubusercontent.com/openssl/openssl/master/test/certs/rootcert.pem">https://raw.githubusercontent.com/openssl/openssl/master/test/certs/rootcert.pem</a></li><li><a href="https://raw.githubusercontent.com/openssl/openssl/master/test/certs/rootkey.pem">https://raw.githubusercontent.com/openssl/openssl/master/test/certs/rootkey.pem</a></li></ul>
<p>These are not bound to any particular domain, so the server can use any <code>setHostname()</code>, and the
client can access the server simply by IP address. The above files worked in the example code below.</p>
<h4>Real Certificates</h4>
<p>Often in the real world, you use certificates to prove domain ownership. You can get certificates
for your domain for free from <a href="https://letsencrypt.org">letsencrypt.org</a> -- you'll have to
provide domain ownership verification.</p>
<p>Notes on using cert files:
- You may need to convert your files to PEM format (Google or <code>openssl</code> CLI tool may help you).
- You may sometimes need to concatenate multiple intermediate / CA pem files into an overall <code>chain.pem</code> file.</p>
<p>In the below example, I'm using <code>foo.example.com</code> as the hostname. Your hostname will vary and
your cert files are bound to a specific hostname, such as <code>myhost.mydomain.com</code>. Some certs
are valid for multiple hosts via a wildcard cert (e.g. <code>*.mydomain.com</code>).</p>
<h4>Testing your certs on localhost</h4>
<p>If you want to test a cert for <code>mydomain.com</code> on your local computer (without pushing your code to your live <code>mydomain.com</code> server), you can point <code>mydomain.com</code> at localhost by inserting a line into your <code>/etc/hosts</code> file:</p>
<pre><code>127.0.0.1   mydomain.com</code></pre>
<p>Now requests to <code>mydomain.com</code> will be redirected to 127.0.0.1 (aka, localhost, your computer). You may need to restart your browser or reboot for this change to take effect.</p>
<p>You might generate a certificate for <code>test.mydomain.com</code> or <code>localhost.mydomain.com</code>, specifically for testing or development of SSL / HTTPS connections. You could use <code>/etc/hosts</code> entries on developers computers, or CI servers.</p>
<h3>cpp.Lib.stringReference note</h3>
<p>Note: until <a href="https://github.com/HaxeFoundation/haxe/issues/8457">this issue</a> is fixed in Haxe, you may need to alter <code>haxe/std/cpp/_std/sys/ssl/Key.hx</code> line 17 to use
<code>toString()</code> instead of <code>cpp.Lib.stringReference()</code> as follows:</p>
<pre class="highlighted">
<span class="mtk5">var</span><span class="mtk1"> </span><span class="mtk17">str</span><span class="mtk1"> = </span><span class="mtk17">data</span><span class="mtk1">.</span><span class="mtk10">toString</span><span class="mtk1">(); </span><span class="mtk4">// cpp.Lib.stringReference(data);</span>
</pre>
<h3>About the Server</h3>
<p>This example server uses <a href="https://api.haxe.org/cpp/vm/Thread.html">Threads</a>, where the main thread accepts
connections, and then passes each connected client socket off to a reader thread. The reader thread
simply calls <code>Sys.print()</code> with any data received, and gracefully exits if an end-of-file (<code>Eof</code>) is received.</p>
<p>Using threads, thread messages, and blocking sockets is an efficient design. That way, a thread can simply
sleep until the socket wakes it up. Which is what you want, as opposed to the CPU spinning in a while loop,
endlessly checking if a socket is unblocked.</p>
<p>The server loads my private key and certificate chain files, and listens on port 8000.</p>
<h3>The Code</h3>
<pre class="highlighted">
<span class="mtk5">import</span><span class="mtk1"> sys.net.</span><span class="mtk9">Host</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> sys.net.</span><span class="mtk9">Socket</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> sys.ssl.</span><span class="mtk9">Socket</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk9">SocketSSL</span><span class="mtk1">; </span><span class="mtk4">// aliased to avoid conflict with sys.net.Socket</span>
<span class="mtk5">import</span><span class="mtk1"> sys.ssl.</span><span class="mtk9">Certificate</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> sys.ssl.</span><span class="mtk9">Key</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> cpp.vm.</span><span class="mtk9">Thread</span><span class="mtk1">;</span>

<span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk9">Main</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">function</span><span class="mtk1"> </span><span class="mtk10">main</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">var</span><span class="mtk1"> </span><span class="mtk17">listener_socket</span><span class="mtk1"> = </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk9">SocketSSL</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk5">var</span><span class="mtk1"> </span><span class="mtk17">cert</span><span class="mtk1"> = </span><span class="mtk9">Certificate</span><span class="mtk1">.</span><span class="mtk10">loadFile</span><span class="mtk1">(</span><span class="mtk7">'my_chain.pem'</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk10">setCA</span><span class="mtk1">(</span><span class="mtk17">cert</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk10">setCertificate</span><span class="mtk1">(</span><span class="mtk17">cert</span><span class="mtk1">, </span><span class="mtk9">Key</span><span class="mtk1">.</span><span class="mtk10">loadFile</span><span class="mtk1">(</span><span class="mtk7">'my_private.key'</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk10">setHostname</span><span class="mtk1">(</span><span class="mtk7">'foo.example.com'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk4">// e.g. for an application like an HTTPs server, the client</span>
<span class="mtk1">    </span><span class="mtk4">// doesn't need to provide a certificate. Otherwise we get:</span>
<span class="mtk1">    </span><span class="mtk4">// Error: SSL - No client certification received from the client, </span>
<span class="mtk1">    </span><span class="mtk4">// but required by the authentication mode</span>
<span class="mtk1">    </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk17">verifyCert</span><span class="mtk1"> = </span><span class="mtk5">false</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk4">// Binding 0.0.0.0 means, listen on "any / all IP addresses on this host"</span>
<span class="mtk1">    </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk10">bind</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk9">Host</span><span class="mtk1">(</span><span class="mtk7">'0.0.0.0'</span><span class="mtk1">), </span><span class="mtk8">8000</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk10">listen</span><span class="mtk1">(</span><span class="mtk8">9999</span><span class="mtk1">); </span><span class="mtk4">// big max connections</span>

<span class="mtk1">    </span><span class="mtk14">while</span><span class="mtk1"> (</span><span class="mtk5">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk4">// Accepting socket</span>
<span class="mtk1">      </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'waiting to accept...'</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">var</span><span class="mtk1"> </span><span class="mtk17">peer_connection</span><span class="mtk1">:</span><span class="mtk9">SocketSSL</span><span class="mtk1"> = </span><span class="mtk17">listener_socket</span><span class="mtk1">.</span><span class="mtk10">accept</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk17">peer_connection</span><span class="mtk1"> != </span><span class="mtk5">null</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'got connection from : '</span><span class="mtk1"> + </span><span class="mtk17">peer_connection</span><span class="mtk1">.</span><span class="mtk10">peer</span><span class="mtk1">());</span>
<span class="mtk1">        </span><span class="mtk17">peer_connection</span><span class="mtk1">.</span><span class="mtk10">handshake</span><span class="mtk1">(); </span><span class="mtk4">// This may not be necessary, if !verifyCert</span>

<span class="mtk1">        </span><span class="mtk4">// Spawn a reader thread for this connection:</span>
<span class="mtk1">        </span><span class="mtk5">var</span><span class="mtk1"> </span><span class="mtk17">thrd</span><span class="mtk1"> = </span><span class="mtk9">Thread</span><span class="mtk1">.</span><span class="mtk10">create</span><span class="mtk1">(</span><span class="mtk17">reader</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'sending socket...'</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk17">thrd</span><span class="mtk1">.</span><span class="mtk10">sendMessage</span><span class="mtk1">(</span><span class="mtk17">peer_connection</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'ok...'</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">function</span><span class="mtk1"> </span><span class="mtk10">reader</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">var</span><span class="mtk1"> </span><span class="mtk17">peer_connection</span><span class="mtk1">:</span><span class="mtk9">Socket</span><span class="mtk1"> = </span><span class="mtk5">cast</span><span class="mtk1"> </span><span class="mtk9">Thread</span><span class="mtk1">.</span><span class="mtk10">readMessage</span><span class="mtk1">(</span><span class="mtk5">true</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'new reader thread...'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk14">while</span><span class="mtk1"> (</span><span class="mtk5">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk14">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk9">Sys</span><span class="mtk1">.</span><span class="mtk10">print</span><span class="mtk1">(</span><span class="mtk17">peer_connection</span><span class="mtk1">.</span><span class="mtk17">input</span><span class="mtk1">.</span><span class="mtk10">readString</span><span class="mtk1">(</span><span class="mtk8">1</span><span class="mtk1">));</span>
<span class="mtk1">      } </span><span class="mtk14">catch</span><span class="mtk1"> (</span><span class="mtk17">e</span><span class="mtk1">:haxe.io.</span><span class="mtk9">Eof</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'Eof, reader thread exiting...'</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk14">return</span><span class="mtk1">;</span>
<span class="mtk1">      } </span><span class="mtk14">catch</span><span class="mtk1"> (</span><span class="mtk17">e</span><span class="mtk1">:</span><span class="mtk9">Any</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">trace</span><span class="mtk1">(</span><span class="mtk7">'Uncaught: </span><span class="mtk1">${</span><span class="mtk17">e</span><span class="mtk1">}</span><span class="mtk7">'</span><span class="mtk1">); </span><span class="mtk4">// throw e;</span>
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</pre>
<h3>Testing the Server</h3>
<p>So, let's see it in action!</p>
<p>The project directory contains <code>Main.hx</code>, as well as my cert files, <code>my_chain.pem</code> and <code>my_private.key</code>.</p>
<p>Compile and start the server in one terminal:</p>
<pre><code>&gt; haxe -main Main -debug -cpp out &amp;&amp; ./out/Main-debug
...compiling info removed...
Main.hx:37: waiting to accept...</code></pre>
<p>Now connect from another terminal with a client that's a command line utility for testing ssl connections:</p>
<pre><code>&gt; openssl s_client -connect foo.example.com:8000
...lots of info about the cert...
SSL handshake has read 3374 bytes and written 370 bytes
Verification: OK
---</code></pre>
<p>And it hangs there, waiting for you to type input. On the server side we see:</p>
<pre><code>Main.hx:38: got connection from : { host =&gt; Host, port =&gt; 57394 }
Main.hx:43: sending socket...
Main.hx:45: ok...
Main.hx:35: waiting to accept...
Main.hx:54: new reader thread...</code></pre>
<p>Typing messages into the client terminal, those messages are echoed on the server side as expected.</p>
<p>We can open many clients in separate terminals, they each get their own reader thread.</p>
<p>In the client terminal, hitting <code>CTRL+C</code> exits the client, and on the server we see:</p>
<pre><code>Main.hx:61: Eof, reader thread exiting...</code></pre>
<p>The reader thread exits gracefully, while the server is still running.</p>
<p>Everything is working as expected!</p>
<h3>Next Steps</h3>
<p>When you're ready to take your server past the prototype phase, you'll want to pass some "data processor"
thread to the reader threads (the same way the socket is passed, via <code>Thread.sendMessage()</code>.) Then when
the reader receives data from a client, it would send that data to the data processor thread.</p>
</div><hr/><blockquote class="blockquote author-info"><div class="authors row" itemprop="author" itemscope="itemscope" itemtype="https://schema.org/Person"><span class="span2">Author:</span> <div class="span4"><a href="https://github.com/jcward"><img src="https://github.com/jcward.png?size=80" width="40" height="40" title="Jeff Ward"/></a> <a href="https://github.com/jcward" itemprop="url" rel="external" class="author-name"><span itemprop="name">Jeff Ward</span></a><br/></div> </div> <div class="contributors row"><span class="span2">Contributors:</span> <div class="span4"><a href="https://github.com/markknol" rel="external"><img src="https://github.com/markknol.png?size=40" width="20" height="20" title="Mark Knol"/>  </a><a href="https://github.com/markknol" rel="external" class="author-name">Mark Knol</a><br/></div> </div><div class="row"><span class="span2">Last modified:</span><time class="span4" datetime="2019-07-04 01:01:01" itemprop="dateModified"><span class="fa fa-clock-o"></span> <a href="https://github.com/HaxeFoundation/code-cookbook/commits/master/./assets/content/cookbook/Other/ssl-socket-server.md" rel="external">Jul 04, 2019</a></time></div><div class="row semantic"><span class="span2">Created:</span> <time class="span4" datetime="2019-06-20 01:01:01" itemprop="datePublished"><span class="fa fa-clock-o"></span> Jun 20, 2019</time></div><div class="row semantic"><span class="span2">Category:</span> <span class="span4" itemprop="articleSection"><i class="fa fa-book"></i>&nbsp;<a href="category/other/">Other</a></span></div><div class="row tags"><span class="span2">Tags:</span> <div class="span4"><span itemprop="keywords"><span class="tag"><i class="fa fa-tag"></i>&nbsp;<a href="tag/server.html" rel="tag">server</a><i class="semantic">,</i></span><span class="tag"><i class="fa fa-tag"></i>&nbsp;<a href="tag/multi-threading.html" rel="tag">multi-threading</a><i class="semantic">,</i></span><span class="tag"><i class="fa fa-tag"></i>&nbsp;<a href="tag/hxcpp.html" rel="tag">hxcpp</a></span></span></div></div></blockquote><hr/><div class="contribution"><span><i class="fa fa fa-edit"></i> <a href="https://github.com/HaxeFoundation/code-cookbook/edit/master/./assets/content/cookbook/Other/ssl-socket-server.md?message=Update:%20Prototype SSL Socket Server&amp;description=%0A%0ASources:%0A*%20https://code.haxe.org/category/other/ssl-socket-server.html%0A%0A%40jcward " title="Edit &#039;Prototype SSL Socket Server&#039; on GitHub" rel="external">Edit page</a></span>  <span>| <i class="fa fa-plus-circle"></i> <a href="https://github.com/HaxeFoundation/code-cookbook/new/master/./assets/content/cookbook/Other/snippet-name.md/?filename=snippet-name.md" rel="external" title="Add new page in &#039;Other&#039; on Github">Add new page</a></span> </div><hr/><script src="https://utteranc.es/client.js" repo="HaxeFoundation/haxe.org-comments" branch="master" issue-term="[code.haxe.org] Other - Prototype SSL Socket Server" async="async"></script><center class="share-buttons"><a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="haxe" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>&nbsp; 
<div id="fb-root" style="display:inline-block"></div><script>(function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0];if (d.getElementById(id)) return;js = d.createElement(s); js.id = id;js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";fjs.parentNode.insertBefore(js, fjs);}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-like" data-href="https://code.haxe.org/category/other/ssl-socket-server.html" style="display:inline-block" data-layout="button_count" data-action="like" data-show-faces="true" data-size="large"></div></center></article></section></main></div><footer class="section dark site-footer"><div class="container"><div class="copyright"><p>&copy;2019&nbsp;<a class="hf-link" href="https://haxe.org/foundation/" rel="external" title="Haxe Foundation Website">Haxe Foundation</a> |&nbsp;<a href="https://github.com/HaxeFoundation/code-cookbook" title="Haxe Code Cookbook on GitHub" rel="external">Code Cookbook on GitHub</a> </p><p class="last-modified">Last deploy: Dec 02, 2019</p></div></div></footer><link rel="stylesheet" type="text/css" href="css/font-awesome.css"/><script defer="defer" src="https://haxe.org/js/jquery.min.js"></script><script defer="defer" src="https://haxe.org/js/bootstrap.min.js"></script><script>  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');  ga('create', 'UA-74262827-2', 'auto');  ga('send', 'pageview');</script></body></html>